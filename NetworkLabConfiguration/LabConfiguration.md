## Building A Virtual Network For Analysis

In this document we will build a virtual network that you can use to inspect the network traffic generated by (potentially) malicious software. In particular, we will build a virtual network with two (2) hosts -- one that will act as a router and looking glass and one that will act as the host for potentially malicious software. The guest acting as the router for the internal network will run the Kali distribution of the Linux operating system. In this document, we will assume that the guest that hosts the potentially malicious software will be running the Ubuntu operating system. That said, the ideas explored in this document are applicable to guests running any operating system connected to a virtual network built using VirtualBox.

![A visualization of the virtual network we will build.](./images/VirtualBoxAnalysisNetwork.png)

For the remainder of the document, we will refer to the virtual network built using VirtualBox simply as the _virtual network_. We will refer to the guest running the Kali distribution of the Linux operating system as the _Kali VM_. We will refer to the guest running the Ubuntu distribution of the Linux operating system as the _analysis VM_ (because it would be where you will be doing malware analysis.)

## Network Setup

Because the Kali VM is going to be the router between the virtual network and the Internet (via your host's Internet connection), it will be [dual-homed](https://en.wikipedia.org/wiki/Dual-homed). One of the VM's virtual network interfaces will connect to the Internet (again, by your host's Internet connection) and the other will connect to the virtual network. The network diagram above visually indicates the dual homing by showing the Kali VM straddling the boundary of the virtual network. 

The analysis machine will only have a single network interface card (NIC). That NIC will be connected only to the virtual network.

We will _not_ run a DHCP server on this virtual network. As a result, we will have to manusally assign IP addresses to each of the VMs. The virtual network's address will be 10.3.2.0/24. The NIC in the Kali VM attached to the virtual network will have the IP address 10.3.2.1. The NIC in the analysis machine attached to the virtual network will have the IP address 10.3.2.2. We will specify further IP configuration options as we go into further detail throughout the lab.

### Assumptions

It is assumed that you have installed a Kali and an Ubuntu guest on the same physical host and are virtualizing them with VirtualBox. For additional information on how to perform these installations, see the class' Wiki.

### Configuring the Guests's NICs

Begin by opening up VirtualBox. Select the Kali VM and then open its settings. 

![TODO](./images/virtualboxbasicinterface-kali.png)

Click on _Network_ in the left-hand pane.

![TODO](./images/virtualboxbasicsettings.png)

Leave _Adapter 1_ configured as it was. It could be set as _Bridged Adapter_ or _NAT_ -- either one is perfectly acceptable.

Click on _Adapter 2_. Check the box labeled _Enable Network Adapter_. Select _Internal Network_ as the value of the _Attached to:_ drop-down menu. In the _Name:_ text box, type "analysis". "analysis" will be the name of the virtual network we build in this lab. Any VMs that have a NIC that connects to the "analysis" _Internal Network_ will be on the same virtual network and appear to each other as though they are on the same physical network switch. Pretty darn cool!

![TODO](./images/virtualboxkalinetworkanalysis.png)

Press _OK_. 

Next, select the analysis VM and then click _Settings_. 

![TODO](./images/virtualboxbasicinterface.png)

As before, click on _Network_ in the left-hand pane. Select _Internal Network_ in the drop-down next to the _Attached to:_ for _Adapter 1_. In _Name:_, enter "analysis". Press _OK_.

![TODO](./images/virtualboxanalysisnetworkanalysis.png)

### Configuring The VMs: Analysis VM

Boot up the analysis VM. Once you have logged in, click on the network icon in the upper-right hand corner of the screen (indicated in green in the following image), then click on _Wired Connected_ (indicated in blue in the following image), and, finally, click on _Wired Settings_ (indicated in red in the following image). 

![TODO](./images/ubuntudesktopwiredsettings.png)

Click on the gear icon next to the label _Connected - 1000 Mbps_ (indicated in red in the following image). 

![TODO](./images/ubuntunetworksettings.png)

Click on the _IPv4_ tab (indicated in red in the following image). In the _Addresses_ section, make the IP address be 10.3.2.2, the netmask be 255.255.255.0 and the gateway be 10.30.2.1 (indicated in green in the following image). Finally, set 8.8.8.8 as the DNS server (indicated in blue in the following image). When you are done, press _Apply_ (the green button in the upper-right portion of the screen). 

![TODO](./images/ubuntunetworkipv4.png)

Setting the values the way that we did above will assign the analysis machine the 10.3.2.2 IPv4 address on the 10.3.2.0/24 network. It will set the analysis VM's router to 10.3.2.1, the Kali VM (we will configure the Kali VM next). These settings configure the Kali VM to use Google's anycast server at 8.8.8.8 to perform DNS resolution.

### Configuring The VMs: Kali VM

Configuring the Kali VM is slightly more involved. There are two NICs to configure instead of one, after all!

Boot up the Kali VM. Right-click on the network icon in the upper-right hand corner of the screen and click _Edit Connections_.

![TODO](./images/kalieditconnections.png)

By default, the Kali VM assumes that there is only a single NIC. We will have to add the second NIC. In order to do so, click on the _+_ icon in the bottom-left hand corner (indicated in red in the following figure).

![TODO](./images/kaliaddconnection.png)

Choose the _Ethernet_ connection type and then click _Create ..._. 


![TODO](./images/kalicreateconnection.png)

Select _eth1_ as the _Device_ (indicated in green in the following figure). Then, click on the IPv4 tab (indicated in red in the following figure).

![TODO](./images/kalieth1connection.png)

Under _Method_, select _Manual_ (indicated in yellow in the following image). Then, in the _Additional static addresses_ section (indicated in red in the following image), set the IP address to 10.3.2.1, the netmask to 255.255.255.0 and leave the gateway blank. As in the configuration of the NIC for the analysis VM, set the DNS server to 8.8.8.8 (indicated in green in the following image). Finally, press _Save_. 

### Verifying Configuration So Far

At this point, we should stop to verify the configuration so far. On the analysis VM, open the terminal emulator and attempt to `ping` the Kali VM:

```
$ ping 10.3.2.1
```

If you do not get reply packets, go back and check your configuration to make sure that everything matches. If you continue to have trouble, please contact Will.

On the Kali VM, open the terminal emulator and attempt to `ping` the analysis VM:

```
$ ping 10.3.2.2
```

If you do not get reply packets, go back and check your configuration to make sure that everything matches. If you continue to have trouble, please contact Will.

### Configuring the Kali VM as a Router

On the analysis VM, return to the terminal emulator and `ping` Google's anycast DNS server:

```
$ ping 8.8.8.8
```

What? Why aren't we getting any response packets? Leave the `ping` running and return to the Kali VM.

By default, Linux hosts do not act as network routers -- they will not forward packets between interfaces. However, it is easy to enable that functionality. To save you from having to Google for the incantation to make that happen, you can use the `configure_as_router.sh` script in the `network/helpers` directory in the class' `git` repository. 

On the Kali VM, the script as the root user:

```
$ sudo ./configure_as_router.sh
```

As soon as you execute the `configure_as_router.sh` script on the Kali VM, the `ping` packets that you are transmitting on the analysis VM should start to receive responses! 

Congratulations, your Kali VM is now acting as a router to the guests on the virtual network.

### Analysis (1)

Now that we know that there is a network connection between the analysis VM, the Kali VM and the Internet and we know that the packets from the analysis VM destined for the Internet are traversing the NICs of the Kali VM, let's figure out how we can inspect those packets.

On the Kali VM, start Wireshark. It is under the  _Sniffing and Spoofing_ category of the applications in the "Start" menu.

Wireshark is a tool that will "capture" all the packets that transit a particular network interface and display them in a nicely formatted UI. The UI gives us analysts the opportunity to look at different parts of every packet in the context of the different layers of the network stack. For instance, we can use Wireshark to look at a packet as the Ethernet layer sees it, or the IP layer sees it, or the TCP layer sees it, or the application layer sees it. 

Assuming that the `ping` between the analysis VM and the Google anycast DNS server is still running (it is, isn't it?) then we should be able to use Wireshark on the Kali VM to see [ICMP (internet control message protocol)](https://www.rfc-editor.org/rfc/rfc792.html) packets -- the types of packets that are used to implement `ping`. 

The fastest way to get started with Wireshark, is to select _eth1_ (remember, _eth1_ is the network interface of the Kali VM attached to the virtual network) and then click on the blue sharkfin icon (indicated in blue and red, respectively, in the following image).

![TODO](./images/kaliwiresharkstartpng.png)

If everything is working as it should be, you will see packets start popping up. Some of those will be the ICMP requests and replies between 10.3.2.2 and 8.8.8.8 generated from your ongoing `ping`. There are probably lots of other packets clogging up your interface. You can limit the display so that it shows only ICMP packets by using a [_filter_](https://www.wireshark.org/docs/wsug_html_chunked/ChUseFilterToolbarSection.html). 

In the filter toolbar, type `icmp` and press enter. That will limit the _display_ to only ICMP packets. The other packets are still being captured, don't worry -- they just aren't being displayed. You can always clear the filter and again see all the packets.

Pretty cool!